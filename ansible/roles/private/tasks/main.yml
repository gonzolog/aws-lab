---
- name: Ensure Python is installed
  ansible.builtin.apt:
    name: python3
    state: present
    update_cache: true

- name: Create app directory
  ansible.builtin.file:
    path: /opt/private_app
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Deploy app
  ansible.builtin.copy:
    src: app.py
    dest: /opt/private_app/app.py
    owner: root
    group: root
    mode: "0755"
  notify: Restart private app

- name: Deploy systemd unit
  ansible.builtin.template:
    src: private-app.service.j2
    dest: /etc/systemd/system/private-app.service
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Restart private app

- name: Allow app port from web subnet only
  community.general.ufw:
    rule: allow
    port: "{{ private_app_port }}"
    proto: tcp
    from_ip: "{{ web_subnet_cidr }}"

- name: Unmask private-app service if masked
  ansible.builtin.command: systemctl unmask private-app
  changed_when: false
  failed_when: false

- name: Ensure private app is enabled and running
  ansible.builtin.systemd:
    name: private-app
    state: started
    enabled: true
    daemon_reload: true
    
